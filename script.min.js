function getName(e){var a=e.title.split(".");return a[a.length-1].trim()}function shortUrl(e){var a=e["@id"].split("/");return a[a.length-1]}function getLocation(e){return{lat:Number(e.location.latitude),lng:Number(e.location.longitude)}}function startGooglePlusApi(){gapi.client.setApiKey(apiKey),console.log("Google+ API cargada")}function startWebSocket(){try{$("#tab-usuarios .alert-warning").removeClass("invisible");(socket=new ReconnectingWebSocket("wss://shielded-cove-96281.herokuapp.com/users")).onopen=function(e){serverUp()},socket.onclose=function(e){serverDown()},socket.onmessage=function(e){getGPlusUser(e.data)}}catch(e){serverDown()}}function getGPlusUser(e){gapi.client.load("plus","v1",function(){gapi.client.plus.people.get({userId:e,fields:"displayName,id,image/url,url"}).execute(function(e){e.error?console.log(e.error):(console.log(e),addUser(e))})})}function serverUp(){$("#tab-usuarios .alert-danger").addClass("invisible"),$("#tab-usuarios .alert-warning").addClass("invisible"),$("#tab-usuarios .alert-success").removeClass("invisible")}function serverDown(){$("#tab-usuarios .alert-warning").addClass("invisible"),$("#tab-usuarios .alert-success").addClass("invisible"),$("#tab-usuarios .alert-danger").removeClass("invisible"),$("#startServer").removeClass("invisible")}function addParkingListEvents(){setParkingsDraggable(),$(".parking").click(function(e){-1==parkingSelected&&$("#nav-usuarios").removeClass("disabled").attr({"data-toggle":""}).tooltip("destroy"),parkingSelected=Number.parseInt($(this).attr("tag")),showMarker(e.target,parkingSelected)})}function addCollectionListEvents(){$("#collection-list .list-group-item").click(function(e){$("#collection-list .list-group-item").removeClass("list-group-item-info"),collectionSelected=$(this).html().split("<")[0],$(this).addClass("list-group-item-info"),showCollectionParkings(collectionSelected)})}function disableUsersTab(){$("#nav-usuarios").addClass("disabled").attr({"data-toggle":"tooltip","data-placement":"bottom",title:"Selecciona un aparcamiento"}).tooltip()}function orderByName(e,a){return getName(e).localeCompare(getName(a))}function generatePopup(e,a){var t=$("<span>");return t.append($("<h4>",{html:e.name})),$("<p>").html(e.address.street).appendTo(t),$("<button>",{type:"button","data-toggle":"tooltip","data-placement":"bottom",title:"Ver info",class:"btn btn-success",tag:a,html:'<span class="glyphicon glyphicon-info-sign"></span>'}).appendTo(t),$("<button>",{type:"button","data-toggle":"tooltip","data-placement":"bottom",title:"Quitar",class:"btn btn-danger",tag:a,html:'<span class="glyphicon glyphicon-remove-sign"></span>'}).appendTo(t),t}function setPhotos(e){$.ajax({url:"https://commons.wikimedia.org/w/api.php",dataType:"jsonp",data:{action:"query",format:"json",generator:"geosearch",ggsprimary:"all",ggsnamespace:6,ggsradius:1e3,ggscoord:e.lat+"|"+e.lng,ggslimit:"10",prop:"imageinfo",iilimit:1,iiprop:"url",iiurlwidth:200,iiurlheight:200,callback:"processJSON"}})}function newPhotoNode(e,a){var t=$("<div>",{class:"item","data-slide-number":a,html:$("<img src="+e+">")});return 0===a&&t.addClass("active"),t}function newThumbnailNode(e,a){var t=$("<img>",{class:"img-thumbnail",id:"carousel-selector-"+a,src:e});return 0===a&&t.addClass("active"),$("<td>").append(t)}function changeTab(e,a){$("#tab-principal").addClass("invisible"),$("#tab-colecciones").addClass("invisible"),$("#tab-usuarios").addClass("invisible"),$(e).removeClass("invisible"),$(".nav-title").removeClass("active"),$(a).addClass("active")}function setParkingsDraggable(){$(".parking").draggable({containment:$("#tab-colecciones"),disabled:!0,helper:"clone",cursor:"grabbing",cursorAt:{left:5,top:21},zIndex:100,revert:"invalid",revertDuration:200})}function calculateImgSize(e){return console.log(e),200===e?500:Number.parseInt(Math.floor(500*e/200))}function createMarker(e,a){var t=e.location.lat,s=e.location.lng,i=L.marker([t,s]),o=generatePopup(e,a);return i.bindPopup(o.prop("outerHTML")),i}function showMarker(e,a){mymap.panTo(parkings[a].location),markers.includes(a)?parkings[a].marker.openPopup():(parkings[a].marker.addTo(mymap).openPopup(),$(e).append($("<span class='glyphicon glyphicon-map-marker'>")),markers.push(Number.parseInt(a))),addPopupEvents(),$('[data-toggle="tooltip"]').tooltip()}function removeMarker(e){var a=parkings[e].marker,t=markers.indexOf(e);markers.splice(t,1),mymap.removeLayer(a),$(".list-group-item[tag="+e+"] span").remove()}function addPopupEvents(){$(".leaflet-popup-content .btn-success").click(function(){showInfo($(this).attr("tag"))}),$(".leaflet-popup-content .btn-danger").click(function(){var e=Number($(this).attr("tag")),a=$("#parking-list").children()[e];collectionSelected&&collections[collectionSelected].includes(e)&&(a=$("#added-list li[tag="+e+"]")),removeMarker(e),$(a).removeClass("list-group-item-info")})}function loadParkings(){$.getJSON("aparcamientos.json").done(function(e,a){if("success"===a){parkings=processData(e),prepareParkingList();var t="[";$.each(parkings,function(e,a){var s=a.toString();t=e!==parkings.length-1?t.concat(s,","):t.concat(s,"]")}),localStorage.setItem("parkings",t)}})}function processData(e,a){a||e.sort(orderByName);var t=[];return $.each(e,function(e,s){var i=new Parking(s,a);i.marker=createMarker(i,e),i.marker.on("click",function(a){$(".list-group-item[tag="+e+"]").click()}),t.push(i)}),t}function showInfo(e){var a=parkings[e];$("#modalInfo #title").html(a.name),$("#modalInfo #address").html(a.address.street),$("#modalInfo #desc").html(a.others),$("#modalInfo #area").html(a.address.area),$("#modalInfo #area").append(" ("+a.address.district+")</br>"),$("#modalInfo #area").append($("<span>",{id:"postal-code",html:"Código postal: "+a.address["postal-code"]})),setPhotos(a.location)}function prepareParkingList(){$("#load_ad").remove(),$("#tab-principal .tab-content").removeClass("invisible"),$(".nav .disabled").removeClass("disabled"),disableUsersTab(),$.each(parkings,function(e,a){var t=$("<li>",{class:"list-group-item parking",tag:e});t.html(a.name),$("#parking-list").append(t)}),addParkingListEvents()}function processJSON(e){$("#myCarousel .carousel-inner").empty(),$("#slider-thumbs tr").empty(),$(Object.entries(e.query.pages)).each(function(e,a){var t=a[1].imageinfo[0],s=calculateImgSize(t.thumbwidth),i=newPhotoNode(t.thumburl.replace(/(.jpg)\/([0-9]+)px/i,"$1/"+s+"px"),e),o=newThumbnailNode(t.thumburl,e);$("#myCarousel .carousel-inner").append(i),$("#slider-thumbs tr").append(o)}),$("#tab-principal").hasClass("invisible")||$("body > #modalInfo").modal("show"),playCarousel()}function playCarousel(){$("#myCarousel").carousel(),$("#myCarousel").on("slide.bs.carousel",function(e){$("[id^=carousel-selector-]").removeClass("active");var a=$(e.relatedTarget).attr("data-slide-number");$("#carousel-selector-"+parseInt(a)).addClass("active")}),$("[id^=carousel-selector-]").click(function(){var e=this.id.split("-");e=parseInt(e[e.length-1]),$("#myCarousel").carousel(e)})}function setBadges(){if($("#available-parks-badge").html(parkings.length),$("#collections-badge").html(collections.length),collectionSelected){console.log(collectionSelected);var e=collections[collectionSelected];$("#parks-added-badge").html(e.length),$("#available-parks-badge").html(parkings.length-e.length)}}function showCollections(){$("#collection-list").empty();var e=Object.keys(collections);e.sort(function(e,a){var t=e.toLocaleUpperCase(),s=a.toLocaleUpperCase();return t.localeCompare(s)}),$.each(e,function(e,a){var t=$("<li>",{class:"list-group-item"});t.html(a),t.append($("<span class=badge>").html(collections[a].length)),$("#collection-list").append(t)}),addCollectionListEvents(),setBadges()}function showCollectionParkings(e){$("#added-list").empty().removeClass("invisible"),$(".parking").removeClass("invisible"),$.each(collections[e],function(e,a){$(".parking[tag="+a+"]").addClass("invisible");var t=$("<li>",{class:"list-group-item added",tag:a,html:parkings[a].name});markers.includes(a)&&t.append($("<span class='glyphicon glyphicon-map-marker'>")),$("#added-list").append(t)}),$(".added").draggable({containment:$("#tab-colecciones"),helper:"clone",cursor:"grabbing",cursorAt:{left:5,top:21},zIndex:100,revert:"invalid",revertDuration:200}),setBadges()}function showInfoInUsersTab(){$("#parkInfo").empty(),$("#modalInfo #title").html!==parkings[parkingSelected].name&&showInfo(parkingSelected);var e=$("#modalInfo").clone();$(e).removeClass("modal fade").css({display:"block"}),$(e).children().removeClass("modal-dialog");var a=$(e).children().children()[0];$(a).css({"box-shadow":"unset"}),$(a).children(".modal-footer").remove(),$("#parkInfo").append(e),$("#parkInfo #slider-thumbs").addClass("hidden-xs")}function addUser(e){if(!usersReceived[e.id.toString()]){var a=e.image.url.split("=")[0].concat("=80"),t={id:e.id.toString(),url:a,name:e.displayName,profile:e.url};usersReceived[e.id.toString()]=t,setUserPhoto(t)}}function showParkingUsers(e,a){a||($("#parkUsers").empty(),$("#users .user").removeClass("invisible")),$.each(asociatedUsers[e.name],function(e,a){if(!$("#parkUsers").has("#"+a).length){var t=$("#users .available#"+a).clone();t.removeClass("available").addClass("added"),$("#users .available#"+a).addClass("invisible"),$("#parkUsers").append(t)}}),setUsersDrag()}function setUsersDrag(){$('[data-toggle="tooltip"]').tooltip(),$(".user").draggable({containment:$("#usersManagement"),helper:"clone",cursor:"grabbing",cursorAt:{left:40,top:40},zIndex:100,revert:"invalid",revertDuration:200})}function restoreUsers(e){$.each(e,function(e,a){setUserPhoto(a)}),-1!==parkingSelected&&showParkingUsers(parkings[parkingSelected])}function setUserPhoto(e){$("<img>").attr({src:e.url,id:e.id,class:"img-circle user available","data-toggle":"tooltip","data-placement":"top",title:e.name}).appendTo($("#users")).click(function(){window.open(e.profile,"_blank")}),setUsersDrag()}function getGithubFormData(e){var a=$("#githubModal form")[0],t=$(a.token).val(),s=$(a.user).val(),i=$(a.repo).val(),o=$(a.file).val()||$(a.file).attr("placeholder");t&&s&&i?"save"===e?exportData(t,s,i,o,$(a.commit).val()||$(a.commit).attr("placeholder")):importData(t,s,i,o):$("#githubModal .alert-warning").removeClass("invisible")}function exportData(e,a,t,s,i){var o=new GitHub({token:e}).getRepo(a,t),n={collections:collections,users:usersReceived,parkingUsers:asociatedUsers};o.writeFile("master",s,JSON.stringify(n,null,4),i,{},cb)}function importData(e,a,t,s){new GitHub({token:e}).getRepo(a,t).getContents("master",s,!0,read)}function cb(e,a){e||(alert("Guardado"),hideModal())}function read(e,a){e||(collections=a.collections,asociatedUsers=a.parkingUsers,showCollections(),restoreUsers(a.users),hideModal())}function hideModal(){$("#githubModal").modal("hide")}var Parking=function(e,a){a?(this.name=e.name,this.address=e.address,this.location=e.location,this.others=e.others):(this.name=getName(e),this.address={district:shortUrl(e.address.district),area:shortUrl(e.address.area),"postal-code":Number(e.address["postal-code"]),street:e.address["street-address"]},this.location=getLocation(e),this.others=e.organization["organization-desc"]),this.toString=function(){return JSON.stringify({name:this.name,address:this.address,location:this.location,others:this.others})}},apiKey="AIzaSyCmLE0CXrcYwlIEfF1nT2PwWWW76c-85_w",socket=null;$("#startServer").click(function(e){startWebSocket(),$(e.target).addClass("invisible")}),$("#nav-principal").click(function(e){e.preventDefault(),$("#nav-principal").hasClass("active")||(collectionSelected&&($("#collection_ad").remove(),$("#added-list").appendTo($("#collection-parking-list")),$(".added").draggable("disable"),$("#added-list li").addClass("parking"),addParkingListEvents()),changeTab("#tab-principal",this),$(".parking").draggable("disable"),$("#parkInfo").empty(),$("#tab-principal .tab-content").append($("#parking-list")),-1!=parkingSelected&&$(".list-group-item[tag="+parkingSelected+"]").click())}),$("#nav-colecciones").click(function(e){e.preventDefault(),$("#nav-colecciones").hasClass("active")||$("#nav-colecciones").hasClass("disabled")||($("#tab-principal").has($("#added-list")).length&&($("#tab-principal #added-list").appendTo($("#col-parkings-added")),$("#added-list li").removeClass("parking"),$(".added").draggable("enable")),changeTab("#tab-colecciones",this),$(".parking").draggable("enable"),$("#col-disponibles").append($("#parking-list")),setBadges())}),$("#nav-usuarios").click(function(e){e.preventDefault(),$("#nav-usuarios").hasClass("active")||$("#nav-usuarios").hasClass("disabled")||(changeTab("#tab-usuarios",this),showInfoInUsersTab(),showParkingUsers(parkings[parkingSelected]))}),$("#newCollectionForm button").click(function(){var e=$("#newCollectionForm input").val();$("#newCollectionForm input").val(""),collections[e]?alert("La colección "+e+" ya existe."):(collections[e]=[],collectionSelected=e),showCollections(),showCollectionParkings()});var center=[40.41963869,-3.6738968],mymap=L.map("map").setView(center,12),markers=[];L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',maxZoom:19}).addTo(mymap);var parkings=localStorage.getItem("parkings"),parkingSelected=-1;parkings&&(parkings=processData(JSON.parse(parkings),!0),prepareParkingList());var collections={},collectionSelected=null;$.getJSON("default-collections.json").done(function(e,a){"success"===a&&(collections=e,showCollections())}),$("#col-parkings-added").droppable({accept:".parking",drop:function(e,a){if(collectionSelected){var t=Number.parseInt($(a.draggable).attr("tag"));a.draggable.addClass("invisible"),collections[collectionSelected].push(t),collections[collectionSelected].sort(function(e,a){return e-a}),showCollections(),showCollectionParkings(collectionSelected)}}}),$("#col-disponibles").droppable({accept:".added",drop:function(e,a){var t=Number.parseInt(a.draggable.attr("tag")),s=collections[collectionSelected].indexOf(t);a.draggable.remove(),collections[collectionSelected].splice(s,1),$(".parking[tag="+t+"]").removeClass("invisible"),showCollections()}});var usersReceived={},asociatedUsers={};$("#parkUsers").droppable({accept:".available",drop:function(e,a){var t=a.draggable.attr("id");asociatedUsers[parkings[parkingSelected].name]||(asociatedUsers[parkings[parkingSelected].name]=[]),asociatedUsers[parkings[parkingSelected].name].includes(t)||asociatedUsers[parkings[parkingSelected].name].push(t),showParkingUsers(parkings[parkingSelected],!0)}}),$("#users").droppable({accept:".added",drop:function(e,a){var t=a.draggable.attr("id"),s=asociatedUsers[parkings[parkingSelected].name].indexOf(t);a.draggable.remove(),asociatedUsers[parkings[parkingSelected].name].splice(s,1),$(".user[id="+t+"]").removeClass("invisible")}}),$("#addUser button").click(function(){getGPlusUser($("#addUser input").val())}),$("#save-data").click(function(){this.hasClass("disabled")||($("#githubModal .alert").addClass("invisible"),$("#githubModal h3").html("Guardar datos"),$("#githubModal #commitInput").removeClass("invisible"),$("#githubModal").modal("show"),$("#githubModal button.btn-success").html("Guardar").click(function(e){e.preventDefault(),getGithubFormData("save")}))}),$("#load-data").click(function(){this.hasClass("disabled")||($("#githubModal .alert").addClass("invisible"),$("#githubModal h3").html("Cargar datos"),$("#githubModal #commitInput").addClass("invisible"),$("#githubModal").modal("show"),$("#githubModal button.btn-success").html("Cargar").click(function(e){e.preventDefault(),getGithubFormData("load")}))});
